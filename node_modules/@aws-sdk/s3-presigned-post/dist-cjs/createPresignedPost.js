"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createPresignedPost = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const util_format_url_1 = require("@aws-sdk/util-format-url");
const middleware_endpoint_1 = require("@smithy/middleware-endpoint");
const signature_v4_1 = require("@smithy/signature-v4");
const util_hex_encoding_1 = require("@smithy/util-hex-encoding");
const util_utf8_1 = require("@smithy/util-utf8");
const constants_1 = require("./constants");
const createPresignedPost = async (client, { Bucket, Key, Conditions = [], Fields = {}, Expires = 3600 }) => {
    const { systemClockOffset, base64Encoder, utf8Decoder, sha256 } = client.config;
    const now = new Date(Date.now() + systemClockOffset);
    const signingDate = iso8601(now).replace(/[\-:]/g, "");
    const shortDate = signingDate.slice(0, 8);
    const clientRegion = await client.config.region();
    const credentialScope = (0, signature_v4_1.createScope)(shortDate, clientRegion, "s3");
    const clientCredentials = await client.config.credentials();
    const credential = `${clientCredentials.accessKeyId}/${credentialScope}`;
    const fields = {
        ...Fields,
        bucket: Bucket,
        [constants_1.ALGORITHM_QUERY_PARAM]: constants_1.ALGORITHM_IDENTIFIER,
        [constants_1.CREDENTIAL_QUERY_PARAM]: credential,
        [constants_1.AMZ_DATE_QUERY_PARAM]: signingDate,
        ...(clientCredentials.sessionToken ? { [constants_1.TOKEN_QUERY_PARAM]: clientCredentials.sessionToken } : {}),
    };
    const expiration = new Date(now.valueOf() + Expires * 1000);
    const conditionsSet = new Set();
    for (const condition of Conditions) {
        const stringifiedCondition = JSON.stringify(condition);
        conditionsSet.add(stringifiedCondition);
    }
    for (const [k, v] of Object.entries(fields)) {
        conditionsSet.add(JSON.stringify({ [k]: v }));
    }
    if (Key.endsWith("${filename}")) {
        conditionsSet.add(JSON.stringify(["starts-with", "$key", Key.substring(0, Key.lastIndexOf("${filename}"))]));
    }
    else {
        conditionsSet.add(JSON.stringify({ key: Key }));
    }
    const conditions = Array.from(conditionsSet).map((item) => JSON.parse(item));
    const encodedPolicy = base64Encoder(utf8Decoder(JSON.stringify({
        expiration: iso8601(expiration),
        conditions,
    })));
    const signingKey = await (0, signature_v4_1.getSigningKey)(sha256, clientCredentials, shortDate, clientRegion, "s3");
    const signature = await hmac(sha256, signingKey, encodedPolicy);
    const endpoint = (0, middleware_endpoint_1.toEndpointV1)(await (0, middleware_endpoint_1.getEndpointFromInstructions)({ Bucket, Key }, client_s3_1.PutObjectCommand, {
        ...client.config,
    }, {
        logger: client.config.logger,
    }));
    return {
        url: (0, util_format_url_1.formatUrl)(endpoint),
        fields: {
            ...fields,
            key: Key,
            Policy: encodedPolicy,
            [constants_1.SIGNATURE_QUERY_PARAM]: (0, util_hex_encoding_1.toHex)(signature),
        },
    };
};
exports.createPresignedPost = createPresignedPost;
const iso8601 = (date) => date.toISOString().replace(/\.\d{3}Z$/, "Z");
const hmac = (ctor, secret, data) => {
    const hash = new ctor(secret);
    hash.update((0, util_utf8_1.toUint8Array)(data));
    return hash.digest();
};
